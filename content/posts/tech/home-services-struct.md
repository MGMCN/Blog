---
title: "Home Services Struct"
date: 2025-12-03T22:20:40+09:00
draft: false
categories: [tech]
tags: ["deploy","network"]
summary: æœ¬æ–‡è®²è¿°æˆ‘åœ¨å®¶ä½¿ç”¨æ ‘è“æ´¾å’ŒMac miniéƒ¨ç½²äº†ä»€ä¹ˆæœ‰æ„æ€çš„æœåŠ¡ï¼Œä»¥åŠæˆ‘æ˜¯å¦‚ä½•æ¶æ„çš„
author: "MGMCN"
showToc: false
TocOpen: false
hidemeta: false
comments: true
disableShare: false
disableHLJS: false
hideSummary: false
searchHidden: false
ShowReadingTime: true
ShowBreadCrumbs: true
ShowPostNavLinks: true
ShowWordCount: false
ShowRssButtonInSectionTermList: true
UseHugoToc: true
# cover:
#     image: "<image path/url>" # image path/url
#     alt: "<alt text>" # alt text
#     caption: "<text>" # display caption under cover
#     relative: false # when using page bundles set this to true
#     hidden: true # only hide on current single page
---

# æ¶æ„å›¾
é¦–å…ˆæ¥çœ‹çœ‹æˆ‘çš„å®¶ç”¨æœåŠ¡æ¶æ„å›¾å§ï¼  
![image](/img/home-struct.png)

## ç›‘æ§
æŠŠç›‘æ§æ”¾åœ¨å‰é¢è®²æ˜¯å› ä¸ºè®¸å¤šäººåœ¨éƒ¨ç½²å®¶ç”¨æœåŠ¡çš„æ—¶å€™å¾€å¾€ä¼šå¿½ç•¥è¿™ä¸€å—ï¼Œå¾ˆå¤šæ—¶å€™åªæ˜¯æƒ³ç«‹é©¬è¿è¡Œä¸€ä¸ªæœåŠ¡ç„¶åç«‹å³å°±èƒ½ä½¿ç”¨ï¼Œæ²¡æœ‰è€ƒè™‘å¯¹æœåŠ¡çš„å¥åº·çŠ¶æ€æŒç»­ç›‘æ§ï¼Œè¿™ä¼šå¯¼è‡´å¶å‘çš„æœåŠ¡æ–­è¿å¹¶æœªè¢«å¯Ÿè§‰ï¼Œè¿›è€Œåœ¨æœªæ¥å‘å±•æˆæ›´å¤§çš„ç³»ç»Ÿæ€§é—®é¢˜ã€‚

ä¸‹é¢æˆ‘ä¼šè¯¦ç»†æè¿°Grafanaå’ŒUptime kumaçš„èŒèƒ½ã€‚

æˆ‘å¯ä»¥é€šè¿‡GrafanaæŸ¥è¯¢influxdbå’Œlokiä¸­çš„ç³»ç»ŸçŠ¶æ€ï¼Œç³»ç»Ÿæ—¥å¿—å®ç°å¯è§†åŒ–çš„ç›‘æ§å’Œè¯Šæ–­ï¼ŒåŒæ—¶æˆ‘ä¹Ÿèƒ½é€šè¿‡Uptime kumaç›‘æ§æ‰€æœ‰æœåŠ¡çš„å¥åº·çŠ¶æ€ã€‚

ä¸€ä¸ªå…·ä½“çš„æ¡ˆä¾‹æ˜¯å½“æˆ‘çš„xray-home-vpnæœåŠ¡downäº†åï¼ŒUptime kumaé€šè¿‡curlå‘ç°è¯¥æœåŠ¡unhealthyï¼Œé‚é€šè¿‡é‚®ä»¶å‘ŠçŸ¥æˆ‘xray-home-vpn service may downã€‚è¿™ä¸ªæ—¶å€™æˆ‘å¯ä»¥é€šè¿‡Grafanaé¢æ¿æŸ¥è¯¢xray-home-vpnç›¸å…³çš„ç³»ç»Ÿæ—¥å¿—ä»è€Œè¯Šæ–­æ ¹æœ¬åŸå› ã€‚ï¼ˆè¿™ä¸€ç³»åˆ—çš„æ“ä½œéƒ½æœªæ¶‰åŠsshåˆ°æœåŠ¡å™¨çš„æŒ‡ä»¤æ“ä½œã€‚ï¼‰å½“æˆ‘è¯Šæ–­å‡ºroot causeåæˆ‘å¯ä»¥å†³å®šæ˜¯å¦é€šè¿‡3x-ui-panelé‡å¯è¯¥æœåŠ¡ï¼Œæˆ–è€…è¿›è¡Œå…¶ä»–åç»­çš„æ“ä½œï¼Œä¾‹å¦‚ä¿®æ”¹é…ç½®ç­‰ç­‰ã€‚ï¼ˆæ­¤å¤„å¯èƒ½æ¶‰åŠsshåˆ°æœåŠ¡å™¨åçš„æŒ‡ä»¤æ“ä½œï¼‰

```
                           +-----------------------------+
                           |         Uptime Kuma         |
                           |      (health checking)      |
                           +-------------+---------------+
                                         |
                                         | periodic curl
                                         v
                           +-----------------------------+
                           |    xray-home-vpn service    |
                           +-------------+---------------+
                                         |
                                         | if Unhealthy
                                         v
                           +-----------------------------+
                           |       Send alert email      |
                           +-------------+---------------+
                                         |
                                         v
                           +-----------------------------+
                           |       User gets notice      |
                           +-------------+---------------+
                                         |
                                         v
                           +-----------------------------+
                           |   Open Grafana dashboard    |
                           +-------------+---------------+
                                         |
                                         | Query Loki logs
                                         | and InfluxDB metrics
                                         v
                           +-----------------------------+
                           |     Diagnose root cause     |
                           +-------------+---------------+
                                         |
                                         v
                           +-----------------------------+
                           |  Need to restart service?   |
                           +-------------+---------------+
                                    /           \
                                  yes           no
                                   v             v
        +-----------------------------+     +-----------------------------+
        |   Restart via 3x-ui panel   |     |  Change config / tune sys.  |
        +-------------+---------------+     +-------------+---------------+
                            \__________________________/
                                          |
                                          v
                           +-----------------------------+
                           |      Service back to OK     |
                           +-----------------------------+
```

---

## å®‰å…¨
æ²¡æœ‰ç»å¯¹çš„ç½‘ç»œå®‰å…¨ï¼Œå¦‚æœæœ‰ä¸“ä¸šçš„é»‘å®¢ä¼å›¾çªƒå–æˆ‘ä»¬çš„ä¿¡æ¯ï¼Œé‚£ä¹ˆæ€»èƒ½æ‰¾åˆ°ä¸€ä¸ªçªç ´å£ã€‚æ­¤å¤„æˆ‘æä¾›å¤§ä¼—éƒ½åœ¨ä½¿ç”¨çš„ä¸€äº›å®‰å…¨ç­–ç•¥ã€‚é¦–å…ˆæ˜¯ç™»é™†éªŒè¯ï¼Œæ‰€æœ‰å¯¹å¤–æ˜ å°„æœåŠ¡çš„è®¿é—®éƒ½å¿…é¡»ç»è¿‡ç™»é™†éªŒè¯ï¼Œè¿™ä¸€ç‚¹ä¸Šè¯¸å¦‚Nextcloudï¼Œ3x-ui-panelï¼ŒPihole-panelï¼ŒGrafana-dashboardï¼ŒUptime-kuma-dashboardéƒ½å·²è‡ªå¸¦ï¼Œç›´æ¥å¯ç”¨å³å¯ã€‚é™¤æ­¤ä¹‹å¤–æˆ‘è¿˜æ¨èä½¿ç”¨Cloudflareæä¾›çš„Access Protectionï¼Œé€šè¿‡ç®€æ˜“çš„é…ç½®ä½ å°±èƒ½åœ¨åˆ«äººè®¿é—®ä½ æœåŠ¡å‰å¢åŠ ä¸€é“è®¤è¯ã€‚åªæœ‰é€šè¿‡Cloudflareè®¤è¯çš„è¯·æ±‚æ‰ä¼šè¢«redirectåˆ°ä½ çœŸæ­£æœåŠ¡çš„å…¥å£å¤„ã€‚

å½“æˆ‘å¯ç”¨grafanaçš„Access Protectionçš„æ—¶å€™ï¼Œä¸€ä¸ªå…·ä½“æ¡ˆä¾‹æ˜¯å½“æˆ‘åœ¨å…¬ç½‘è¯•å›¾è®¿é—®Grafana dashboardçš„æ—¶å€™æˆ‘ä¼šå…ˆè®¿é—®Cloudflareæä¾›çš„è®¤è¯é¡µé¢ä¾‹å¦‚é€šè¿‡æˆ‘çš„é‚®ç®±æ¥æ”¶éªŒè¯ç ï¼Œå¦‚æœè®¿é—®è€…å¹¶æœªè¢«åŠ å…¥ç™½åå•ï¼Œé‚£ä¹ˆå³ä¾¿è®¿é—®è€…è¾“å…¥äº†è‡ªå·±çš„é‚®ç®±ä¹Ÿæ— æ³•æ¥æ”¶åˆ°éªŒè¯ç ã€‚å½“æˆ‘æ¥æ”¶åˆ°Cloudflareå‘é€çš„éªŒè¯ç å®ŒæˆéªŒè¯åï¼Œæˆ‘ä¼šè¢«redirectåˆ°grafanaçš„loginå…¥å£ï¼Œè¿™æ˜¯ç¬¬äºŒé“é˜²çº¿ä¹Ÿå°±æ˜¯æˆ‘ä¹‹å‰æåˆ°çš„å¸¸è§„ç™»é™†éªŒè¯ã€‚

```
+-----------+               +--------------------+               +-------------------+
| Visitor   |               | Cloudflare Access  |               | Grafana Server    |
+-----------+               +--------------------+               +-------------------+
     |                                 |                                   |
     | 1) open Grafana URL             |                                   |
     |-------------------------------->|                                   |
     |                                 |                                   |
     |          2) show login page (email code)                            |
     |<--------------------------------|                                   |
     |                                 |                                   |
     | 3) submit email + code          |                                   |
     |-------------------------------->|                                   |
     |                                 |                                   |
     |                                 | 4) verify & allow request         |
     |                                 |---------------------------------->|
     |                                 |                                   |
     |                                 |        5) forward to Grafana      |
     |                                 |---------------------------------->|
     |                                 |                                   |
     | 6) return Grafana login page (second auth)                          |
     |<--------------------------------------------------------------------|
     |                                 |                                   |
```

---

## åŸŸå
æ¨èè´­ä¹°è‡ªå·±çš„åŸŸåï¼Œè¿™æ ·å¯ä»¥æ›´çµæ´»çš„éƒ¨ç½²è‡ªå·±çš„åº”ç”¨åˆ°å…¬ç½‘ï¼ŒåŒæ—¶ä¹Ÿæ–¹ä¾¿è‡ªå·±è®°å¿†ã€‚ æœ€æ–¹ä¾¿çš„æ–¹å¼æ˜¯é€šè¿‡Cloudflareè´­ä¹°åŸŸåï¼Œä½¿ç”¨Cloudflareçš„DNSæœåŠ¡è§£æåŸŸåï¼Œä½¿ç”¨Cloudflareçš„éš§é“æŠ€æœ¯å®‰å…¨çš„æ˜ å°„è‡ªå·±çš„æœåŠ¡åˆ°å…¬ç½‘ã€‚ï¼ˆæ„Ÿè°¢Cloudflareå¤§å–„äººğŸ™ï¼‰

---

## æœåŠ¡å™¨
è¿™é‡Œä¼šè®¨è®ºåˆ°ç³»ç»Ÿé€‰æ‹©ä»¥åŠç‰©ç†æœºé€‰æ‹©ã€‚

æ ‘è“æ´¾çš„æ€§èƒ½å¯¹äºå¸¸è§„å®¶ç”¨å·²ç»è¿‡å‰©ï¼Œå¦‚æœä½ çš„ç»è´¹ç´§ç¼ºå»ºè®®æ— è„‘å…¥æ ‘è“æ´¾ï¼Œéœ€è¦æ³¨æ„çš„æ˜¯æˆ‘æ¨èä½ ä½¿ç”¨SSDä½œä¸ºæ ‘è“æ´¾çš„ç³»ç»Ÿç›˜è€Œä¸æ˜¯Micro sd cardã€‚è¿™å¯¹äºä½ æœåŠ¡å™¨ç¨³å®šæ€§çš„æå‡æ˜¯è´¨å˜çš„ã€‚è€ƒè™‘åˆ°ç¨³å®šæ€§å’Œä½åŠŸè€—ä»¥åŠä½ æƒ³éƒ¨ç½²è¯¸å¦‚Nextcloudè¿™ç±»çš„ç¨å¤§å‹ç‚¹å„¿çš„æœåŠ¡çš„è¯ï¼Œæˆ‘å»ºè®®ä½ è´­å…¥Mac Miniã€‚ï¼ˆæ­¤å¤„ä¸ºä»€ä¹ˆæ²¡æœ‰é€‰æ‹©ä¸€ä½“æœºçš„NASï¼Œæ˜¯å› ä¸ºè‡ªå·±å–œæ¬¢ä»é›¶å¼€å§‹æŠ˜è…¾ï¼Œä¸å–œæ¬¢å¼€ç®±å³ç”¨ã€‚æˆ‘æ›´äº«å—è‡ªå·±è£¸æœºéƒ¨ç½²å„ç§æœåŠ¡çš„è¿‡ç¨‹ï¼ŒåŒæ—¶å¯å®šåˆ¶æ€§ä¹Ÿæ›´é«˜ä¸€äº›ã€‚ï¼‰

ç³»ç»Ÿçš„è¯æ¨èUbuntu LTSç‰ˆæœ¬ï¼Œä¹Ÿå¯æ ¹æ®ä½ è‡ªå·±åå¥½é€‰æ‹©ã€‚å¦‚æœè€ƒè™‘åˆ°è½»é‡å’Œæè‡´æ€§èƒ½çš„è¯å¯ä»¥ä½¿ç”¨Raspberry Pi OSã€‚ä½¿ç”¨ä½“éªŒä¸Šå’ŒUbuntuå¹¶æ— å·®åˆ«ã€‚

---

## æœåŠ¡
è¿™é‡Œä¼šè®²å‡ ä¸ªæ¯”è¾ƒæœ‰è¶£çš„æœåŠ¡ä¾‹å¦‚Nextcloudå’ŒPi-holeã€‚
å‰©ä¸‹çš„è¯¸å¦‚çŠ¶æ€é‡‡é›†ï¼Œæ—¥å¿—æ”¶é›†çš„æœåŠ¡ä½ å¯ä»¥æ ¹æ®ä½ çš„åå¥½è‡ªè¡Œé€‰æ‹©ã€‚

### Nextcloud & Pi-hole ç®€è¦ä»‹ç»

| æœåŠ¡å | åŠŸèƒ½ç®€ä»‹ | ç‰¹ç‚¹ |
|:--------|:----------|:------|
| **Nextcloud** | ç§æœ‰äº‘å­˜å‚¨ä¸åä½œå¹³å°ï¼Œå¯æ›¿ä»£ Google Driveã€Dropbox ç­‰ | æ”¯æŒæ–‡ä»¶åŒæ­¥ã€åœ¨çº¿æ–‡æ¡£ç¼–è¾‘ã€å…±äº«æ—¥å†å’Œé€šè®¯å½•ï¼Œæ’ä»¶ç”Ÿæ€ä¸°å¯Œï¼Œå¯é«˜åº¦æ‰©å±• |
| **Pi-hole** | ç½‘ç»œçº§å¹¿å‘Šä¸è¿½è¸ªæ‹¦æˆªå™¨ | åœ¨å±€åŸŸç½‘å±‚é¢å±è”½å¹¿å‘Šä¸æ¶æ„åŸŸåï¼Œæä¾›è¯¦ç»†çš„ DNS ç»Ÿè®¡å’Œé»‘åå•ç®¡ç†ï¼Œå¯ä½œä¸ºå…¨å®¶ç½‘ç»œçš„â€œå‡€åŒ–ç½‘å…³â€ |

Pi-holeå¯ä»¥å®šä¹‰å±€åŸŸç½‘å†…çš„åŸŸåè§£æé…åˆä½ çš„å®¶ç”¨vpnæœ‰å¾ˆå¤šçš„ç©å„¿æ³•ï¼Œè¿™ä¸ªä¸èµ˜è¿°å¯è‡ªè¡Œæ¢ç´¢ã€‚

---

## å­˜å‚¨
æœ€åè®²åˆ°å­˜å‚¨çš„åŸå› æ˜¯ï¼Œå¯¹äºä¸€ä¸ªç¨³å¥çš„æœåŠ¡å™¨ï¼Œæ¯‹åº¸ç½®ç–‘ä½ éœ€è¦ä¸€ä¸ªç¡¬ç›˜æŸœå¹¶ä¸”å…è®¸å®¹é”™æ€§ï¼Œé‚£ä¹ˆRaid10ä¹Ÿè®¸æ˜¯ä½ çš„æœ€ä½³é€‰æ‹©ã€‚å¦‚æœä½ çš„ç»è´¹å……è¶³ï¼Œä½ è¿˜èƒ½ç»„å»ºå…¶ä»–çš„ç£ç›˜é˜µåˆ—ä»¥ä¿è¯ä½ æ•°æ®çš„å¯é æ€§ã€‚æ­¤å¤„æˆ‘é€‰æ‹©è‡ªå·±è´­ä¹°çš„yottamasterçš„ç¡¬ç›˜æŸœï¼ˆæ— ç¡¬Raidç‰ˆæœ¬ï¼‰é€šè¿‡ä½¿ç”¨OWC softraidç»„å»ºçš„è½¯Raidï¼Œè¿™æ ·å³ä¾¿æˆ‘çš„ç¡¬ç›˜æŸœæˆ–è€…ç¡¬ç›˜æœ¬èº«åäº†ï¼Œæˆ‘éƒ½èƒ½é€šè¿‡è½¯Raidæ›¿æ¢æŸåéƒ¨ä»¶ç›´æ¥æ¢å¤æ•°æ®ã€‚

---

## èŠ±è´¹
ä»¥ä¸Šæåˆ°çš„æ‰€æœ‰æœåŠ¡å’Œç¡¬ä»¶é™¤äº†åŸŸåå’ŒOWC softraidå’Œä½ çš„å®¶ç”¨ç‰©ç†æœºéœ€è¦è‡ªå·±ä»˜è´¹å¤–å‡å…è´¹ã€‚

# è­¦å‘Šâš ï¸
è¯·å‹¿åˆ©ç”¨ä»¥ä¸ŠæŠ€æœ¯ä»äº‹ä»»ä½•è¿æ³•çŠ¯ç½ªè¡Œä¸ºã€‚
